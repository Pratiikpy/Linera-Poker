# Linera Poker - Docker Compose Configuration
#
# STATUS: EXPERIMENTAL / REFERENCE IMPLEMENTATION
#
# This docker-compose.yml serves as:
# 1. Infrastructure-as-Code documentation of the system architecture
# 2. Reference for future containerization efforts
# 3. Blueprint for production deployment
#
# CURRENT LIMITATION:
# Linera SDK does not yet provide official Docker images. This configuration
# demonstrates the INTENDED architecture but requires custom Dockerfile creation
# to be fully operational.
#
# RECOMMENDED DEPLOYMENT:
# Use `deploy/deploy.bash` for reliable local deployment until official
# Linera Docker support is available.
#
# ARCHITECTURE:
# 3 services representing the 3-chain poker system:
#   1. linera-init    - Runs deployment script, creates chains
#   2. linera-service - Runs Linera service for GraphQL queries
#   3. frontend       - React app for game UI
#
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # Linera Initialization Service
  # ============================================================================
  # Runs the deployment script once to:
  # - Request 3 chains from faucet (Table, Player A, Player B)
  # - Build and deploy all contracts
  # - Generate frontend/.env with chain IDs
  # ============================================================================

  linera-init:
    # PLACEHOLDER: Replace with actual Linera base image when available
    # image: ghcr.io/linera-io/linera:0.15
    #
    # For now, would require custom Dockerfile:
    # FROM rust:1.75-slim
    # RUN rustup target add wasm32-unknown-unknown
    # RUN cargo install linera-cli

    build:
      context: .
      dockerfile: Dockerfile.linera
      args:
        LINERA_VERSION: "0.15.6"

    container_name: linera-poker-init

    volumes:
      # Mount project root for deployment script
      - ./:/app
      # Persist Linera wallet data
      - linera-wallet:/root/.config/linera
      # Share deployment state with other services
      - deployment-state:/app/deploy/.state

    working_dir: /app

    # Run deployment script
    # --skip-build flag assumes contracts already built in Dockerfile
    command: ["./deploy/deploy.bash", "--skip-build"]

    environment:
      # Linera faucet URL
      - FAUCET_URL=https://faucet.testnet.linera.net
      # Rust backtrace for debugging
      - RUST_BACKTRACE=1

    # Init container runs once and exits
    restart: "no"

    networks:
      - linera-network

  # ============================================================================
  # Linera Service
  # ============================================================================
  # Runs the Linera GraphQL service for frontend queries
  # Depends on init completing successfully
  # ============================================================================

  linera-service:
    # Same base image as init
    build:
      context: .
      dockerfile: Dockerfile.linera
      args:
        LINERA_VERSION: "0.15.6"

    container_name: linera-poker-service

    volumes:
      # Share wallet data from init
      - linera-wallet:/root/.config/linera
      # Share deployment state
      - deployment-state:/app/deploy/.state

    ports:
      # GraphQL service port
      - "8080:8080"

    # Start Linera service
    command: ["linera", "service", "--port", "8080"]

    depends_on:
      linera-init:
        # Wait for init to complete before starting service
        condition: service_completed_successfully

    # Health check for service readiness
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    restart: unless-stopped

    networks:
      - linera-network

  # ============================================================================
  # Frontend Service
  # ============================================================================
  # React + Vite development server
  # Reads .env generated by linera-init
  # ============================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile

    container_name: linera-poker-frontend

    volumes:
      # Mount frontend source for hot-reload
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      # Share deployment state to read generated .env
      - deployment-state:/deployment-state:ro

    ports:
      # Vite dev server
      - "5173:5173"

    depends_on:
      linera-service:
        # Wait for Linera service to be healthy
        condition: service_healthy

    environment:
      # Vite server configuration
      - VITE_HOST=0.0.0.0
      - VITE_PORT=5173

    # Start Vite dev server
    # First copy .env from shared volume
    command: >
      sh -c "
        if [ -f /deployment-state/.env ]; then
          cp /deployment-state/.env /app/.env
          echo 'Environment variables loaded from deployment'
        else
          echo 'WARNING: .env not found, using defaults'
        fi
        npm run dev -- --host 0.0.0.0
      "

    restart: unless-stopped

    networks:
      - linera-network

# ============================================================================
# Volumes
# ============================================================================
# Persist data across container restarts
# ============================================================================

volumes:
  # Linera wallet data (private keys, chain information)
  linera-wallet:
    driver: local

  # Deployment state (chain IDs, application IDs, .env file)
  deployment-state:
    driver: local

# ============================================================================
# Networks
# ============================================================================
# Isolated network for Linera Poker services
# ============================================================================

networks:
  linera-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
#
# Prerequisites:
# 1. Create Dockerfile.linera (see below for template)
# 2. Create frontend/Dockerfile (see below for template)
#
# To start all services:
#   docker compose up -d
#
# To view logs:
#   docker compose logs -f
#
# To stop all services:
#   docker compose down
#
# To rebuild after code changes:
#   docker compose build
#   docker compose up -d
#
# To access frontend:
#   http://localhost:5173
#
# To query Linera GraphQL:
#   http://localhost:8080
#
# ============================================================================
# DOCKERFILE TEMPLATES
# ============================================================================
#
# --- Dockerfile.linera ---
# Create this file in project root
#
# FROM rust:1.75-slim
#
# # Install system dependencies
# RUN apt-get update && apt-get install -y \
#     build-essential \
#     pkg-config \
#     libssl-dev \
#     curl \
#     git \
#     && rm -rf /var/lib/apt/lists/*
#
# # Install Rust wasm target
# RUN rustup target add wasm32-unknown-unknown
#
# # Install Linera CLI
# ARG LINERA_VERSION=0.15.6
# RUN cargo install linera-service@${LINERA_VERSION} linera@${LINERA_VERSION}
#
# # Set working directory
# WORKDIR /app
#
# # Copy project files
# COPY Cargo.toml Cargo.lock ./
# COPY shared ./shared
# COPY table ./table
# COPY hand ./hand
# COPY token ./token
# COPY deploy ./deploy
#
# # Build contracts
# RUN cargo build --release --target wasm32-unknown-unknown
#
# # Make deployment script executable
# RUN chmod +x deploy/deploy.bash
#
# CMD ["bash"]
#
# --- frontend/Dockerfile ---
# Create this file in frontend directory
#
# FROM node:18-alpine
#
# WORKDIR /app
#
# # Copy package files
# COPY package.json package-lock.json ./
#
# # Install dependencies
# RUN npm ci
#
# # Copy source files
# COPY . .
#
# # Expose Vite dev server port
# EXPOSE 5173
#
# CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
#
# ============================================================================
# PRODUCTION DEPLOYMENT NOTES
# ============================================================================
#
# For production deployment, consider:
#
# 1. Multi-stage builds to reduce image size
# 2. Non-root user for security
# 3. Secret management for private keys (not in volumes)
# 4. Reverse proxy (Nginx/Traefik) for HTTPS
# 5. Resource limits (CPU/memory)
# 6. Logging aggregation (ELK/Loki)
# 7. Monitoring (Prometheus/Grafana)
# 8. Backup strategy for wallet data
# 9. CI/CD integration for automated deployments
# 10. Load balancing for multiple Linera services
#
# Example production additions:
#
#   linera-service:
#     deploy:
#       resources:
#         limits:
#           cpus: '2'
#           memory: 4G
#         reservations:
#           cpus: '1'
#           memory: 2G
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"
#
# ============================================================================
